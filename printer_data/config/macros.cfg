#####################################################################

# Print Start / End

#####################################################################

[gcode_macro PRINT_START]
gcode:
    
    # This part fetches data from your slicer.
    
    {% set target_bed = params.BED|int %}
    {% set target_extruder = params.EXTRUDER|int %}
    {% set target_chamber = params.CHAMBER|default("40")|int %}
    
    # 1. Start Heating
    
    _STATUS_HEATING
    M104 S150                       # Heat nozzle to 150C (safe for Tap probing)
    M190 S{target_bed}              # Set bed target and wait
    
    # 2. Home
    
    _STATUS_HOMING
    G28                             # Full home (XYZ)
    G90                             # Absolute positioning
    BED_MESH_CLEAR                  # Clear old mesh
    
    # 3. Heatsoak Logic
    
    If bed is set > 90C, wait for chamber or soak timer
    
    {% if params.BED|int > 90 %}
    SET_DISPLAY_TEXT MSG="Heatsoak: {target_chamber}c"
    _STATUS_HEATING
    M106 S255                     # Turn on PT-fan to circulate heat
    TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_chamber}
    {% else %}
    SET_DISPLAY_TEXT MSG="Soak for 5min"
    G4 P300000                    # Wait 5 min for bed temp to stabilize
    {% endif %}
    M107                            # Turn off fan
    
    # 4. Leveling (Trident)
    
    # Ensure nozzle is at 150C before probing (prevents oozing & protects bed)
    
    M109 S150
    
    SET_DISPLAY_TEXT MSG="Z-tilt adjust..."
    _STATUS_LEVELING
    Z_TILT_ADJUST
    G28 Z                           # Homes Z again after z_tilt_adjust
    
    # 5. Bed Mesh (KAMP)
    
    SET_DISPLAY_TEXT MSG="Bed mesh..."
    _STATUS_MESHING
    BED_MESH_CALIBRATE              # KAMP will automatically limit mesh to print area
    
    # 6. Final Heat & Purge
    
    SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"
    _STATUS_HEATING
    SMART_PARK                      # KAMP: Move to print area BEFORE heating to prevent ooze
    M109 S{target_extruder}         # Heat nozzle to printing temp
    
    SET_DISPLAY_TEXT MSG="Printing..."
    _STATUS_PRINTING
    VORON_PURGE                     # KAMP: Adaptive Purge
   

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-2.0 F3600                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR
    _STATUS_READY
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END

#####################################################################

# Filament / Color Change

#####################################################################

[gcode_macro LOAD_FILAMENT]
variable_load_distance:  50
variable_purge_distance:  30
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    
    SAVE_GCODE_STATE NAME=load_state
    PARK_FRONT
    
    G91 
    G92 E0
    G1 E{load_distance} F{max_velocity} # fast-load
    G1 E{purge_distance} F{speed} # purge
    G1 E-3.0 F3000                # Retract 3mm to prevent oozing
    
    RESTORE_GCODE_STATE NAME=load_state



[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  50
variable_purge_distance:  30
gcode:
    {% set TARGET_TEMP = params.TARGET_TEMP|default(240)|float %}
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    
    SAVE_GCODE_STATE NAME=unload_state
    PARK_FRONT
    M109 S{TARGET_TEMP}
    
    G91
    G92 E0
    G1 E2 F300             # Purge a tiny bit to soften tip
    G1 E-20 F3000          # Jerk out to break string
    G4 P3000               # Wait 3 seconds for tip to cool/harden in cold zone
    G1 E-{unload_distance} F{max_velocity} # Extract the rest
    
    RESTORE_GCODE_STATE NAME=unload_state
    
[gcode_macro M600]
description: Color change
gcode:
    PAUSE HeaterPreserve=1
    PARK_FRONT

    
#####################################################################

# Utility / Maintenance

#####################################################################

[gcode_macro OFF]
description: Safely Turn off everything
gcode:
M84                                  ; turn steppers off
TURN_OFF_HEATERS                     ; turn bed / hotend off
M107                                 ; turn print cooling fan off
_STATUS_OFF                          ; turn stealthburner off
SET_PIN PIN=caselight VALUE=0        ; turn light off (optional)

[gcode_macro PID_EXTRUDER]
description: PID Tune for the Extruder
gcode:
    {% set TARGET_TEMP = params.TEMP|default(250)|float %}
    PID_CALIBRATE HEATER=extruder TARGET={TARGET_TEMP}
    SAVE_CONFIG

[gcode_macro PID_BED]
description: PID Tune for the Bed
gcode:
    {% set TARGET_TEMP = params.TEMP|default(100)|float %}
    PID_CALIBRATE HEATER=heater_bed TARGET={TARGET_TEMP}
    SAVE_CONFIG

[gcode_macro COLD_PULL]
description: Automated Cold Pull. Usage: COLD_PULL TEMP=220 COOL_TEMP=90
gcode:
    {% set TEMP = params.TEMP|default(220)|float %}
    {% set COOL_TEMP = params.COOL_TEMP|default(90)|float %}
    
    M117 Heating to {TEMP}C...
    M109 S{TEMP}         
    G91
    G1 E5 F300              
    G90
    
    M117 Cooling to {COOL_TEMP}C...
    M109 S{COOL_TEMP}       
    
    M117 Pulling!
    G91
    G1 E-20 F3000          
    G1 E-80 F1000            
    G90
    
    M104 S0                
    M117 Cold Pull Complete
    
[gcode_macro PARK_FRONT]
gcode:
    {% set th = printer.toolhead %}
    G90
    G0 X{th.axis_maximum.x/2} Y{th.axis_minimum.y+5} Z30 F6000
    
[gcode_macro FRONT]
description: Moves to front center
gcode:
PARK_FRONT

[gcode_macro CENTER]
description: Moves to center of bed
gcode:
{% set th = printer.toolhead %}
G90
G0 X{th.axis_maximum.x/2} Y{th.axis_maximum.y/2} Z30 F6000

[gcode_macro REAR]
description: Moves to rear center
gcode:
{% set th = printer.toolhead %}
G90
G0 X{th.axis_maximum.x/2} Y{th.axis_maximum.y - 10} Z30 F6000

[gcode_macro HEAT_SOAK]
description: Heats the bed and runs fans to soak the chamber. Usage: HEAT_SOAK BED=110 CHAMBER=40 DURATION=15
gcode:
    {% set BED_TEMP = params.BED|default(100)|int %}
    {% set CHAMBER_TEMP = params.CHAMBER|default(45)|int %}
    {% set SOAK_TIME = params.DURATION|default(15)|int %}
    
    M117 Heat Soaking...
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={BED_TEMP}
    M106 S255 # Max fan to circulate
    
    # Wait for Bed
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={BED_TEMP}
    
    # Wait for Chamber (if specified)
    {% if CHAMBER_TEMP > 0 %}
        M117 Waiting for Chamber {CHAMBER_TEMP}C...
        TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={CHAMBER_TEMP}
    {% endif %}
    
    # Wait for duration (if specified)
    {% if SOAK_TIME > 0 %}
        M117 Soaking for {SOAK_TIME} mins...
        G4 P{SOAK_TIME * 60000} 
    {% endif %}
    
    M117 Heat Soak Complete
    M107 
    
[gcode_macro TEST_SPEED]

# Home, get position, throw around toolhead, home again.

# If MCU stepper positions (first line in GET_POSITION) are greater than a full step different (your -microsteps), then skipping occurred.

# We only measure to a full step to accomodate right angle encoders.

# At most, your printer should be a full step off after this test.

Usage: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=10

gcode:
    # Speed
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Bounding box (in case the machine min/maxes are not perfect)
    {% set bound = params.BOUND|default(20)|int %}
    
    # Set speed test bounds (machine minimum/maximum positions, inset by the bound)
    {% set x_min = printer.toolhead.axis_minimum.x + bound %}
    {% set x_max = printer.toolhead.axis_maximum.x - bound %}
    {% set y_min = printer.toolhead.axis_minimum.y + bound %}
    {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    # Initial G-Code
    SAVE_GCODE_STATE NAME=TEST_SPEED
    G28
    G90
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed * 60}
    
    {% for i in range(iterations) %}
        G0 X{x_min} Y{y_min} F{speed * 60}
        G0 X{x_max} Y{y_max} F{speed * 60}
        G0 X{x_min} Y{y_min} F{speed * 60}
        G0 X{x_max} Y{y_min} F{speed * 60}
        G0 X{x_min} Y{y_max} F{speed * 60}
        G0 X{x_max} Y{y_min} F{speed * 60}
    {% endfor %}
    
    G0 X{x_min} Y{y_min} F{speed * 60}
    RESTORE_GCODE_STATE NAME=TEST_SPEED

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    # Parameters
    {% set z = params.Z|default(10)|int %}                                                   ; z hop amount

    {% if printer['pause_resume'].is_paused|int == 0 %}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}                              ; set z hop variable for reference in resume macro
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}    ; set hotend temp variable for reference in resume macro

        # SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0                                  ; disable filament sensor
        SAVE_GCODE_STATE NAME=PAUSE                                                          ; save current print position for resume
        BASE_PAUSE                                                                           ; pause print
        {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}       ; check that zhop doesn't exceed z max
            G91                                                                              ; relative positioning
            G1 Z{z} F900                                                                     ; raise Z up by z hop amount
        {% else %}
            { action_respond_info("Pause zhop exceeds maximum Z height.") }                  ; if z max is exceeded, show message and set zhop value for resume to 0
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
        {% endif %}
        G90                                                                                  ; absolute positioning
        G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+5} F6000   ; park toolhead at front center
        SAVE_GCODE_STATE NAME=PAUSEPARK                                                      ; save parked position in case toolhead is moved during the pause (otherwise the return zhop can error)
        {% if params.HeaterPreserve is not defined %}
            M104 S0
        {% endif %}                                                                              ; turn off hotend
        SET_IDLE_TIMEOUT TIMEOUT=43200                                                       ; set timeout to 12 hours
    {% endif %}

[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
gcode:
    # Parameters
    {% set e = params.E|default(2.5)|int %}                                          ; hotend prime amount (in mm)

    {% if printer['pause_resume'].is_paused|int == 1 %}
        #SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1                          ; enable filament sensor
        #INITIAL_RGB                                                                    ; reset LCD color
        SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}  ; set timeout back to configured value
        {% if etemp > 0 %}
            M109 S{etemp|int}                                                        ; wait for hotend to heat back up
        {% endif %}
        RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=100                     ; go back to parked position in case toolhead was moved during pause (otherwise the return zhop can error)
        G91                                                                          ; relative positioning
        M83                                                                          ; relative extruder positioning
        {% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp %}
            G1 Z{zhop * -1} E{e} F900                                                ; prime nozzle by E, lower Z back down
        {% else %}
            G1 Z{zhop * -1} F900                                                     ; lower Z back down without priming (just in case we are testing the macro with cold hotend)
        {% endif %}
        RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=60                          ; restore position
        BASE_RESUME                                                                  ; resume print
    {% endif %}

[gcode_macro UPDATE_GIT
gcode:
    {% set message = params.MESSAGE|default() %}
    {% if message %}
        RUN_SHELL_COMMAND CMD=update_git_script_message PARAMS="'{params.MESSAGE}'"
    {% else %}
        RUN_SHELL_COMMAND CMD=update_git_script
    {% endif %}
    
#####################################################################

# Stealthburner LEDs

#####################################################################
[gcode_macro _sb_vars]
# User settings for the StealthBurner status leds. You can change the status colors and led
# configurations for the logo and nozzle here.
variable_colors: {
        'logo': { # Colors for logo states
            'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
            'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
            'calibrating_z': {'r': 0.8, 'g': 0., 'b': 0.35, 'w': 0.0},
            'heating': {'r': 0.3, 'g': 0.18, 'b': 0.0, 'w': 0.0},
            'homing': {'r': 0.0, 'g': 0.6, 'b': 0.2, 'w': 0.0},
            'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
            'meshing': {'r': 0.2, 'g': 1.0, 'b': 0.0, 'w': 0.0},
            'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
            'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
            'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.1},
        },
        'nozzle': { # Colors for nozzle states
            'heating': {'r': 0.8, 'g': 0.35, 'b': 0.0, 'w':0.0},
            'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
            'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
            'standby': {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w':0.0},
        },
        'thermal': {
            'hot': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
            'cold': {'r': 0.3, 'g': 0.0, 'b': 0.3, 'w': 0.0}
        }
    }
variable_logo_led_name:         "sb_leds" 
# The name of the addressable LED chain that contains the logo LED(s)
variable_logo_idx:              "1" 
# A comma-separated list of indexes LEDs in the logo
variable_nozzle_led_name:       "sb_leds"
# The name of the addressable LED chain that contains the nozzle LED(s). This will
# typically be the same LED chain as the logo.
variable_nozzle_idx:            "2,3"
# A comma-separated list of indexes of LEDs in the nozzle

variable_thermal_config: {
        'extruder': {
            'cool_temp': 40,
            'leds': 'logo',
        },
        'heater_bed': {
            'cool_temp': 40,
            'leds': 'nozzle',
        },
    }
    
[gcode_macro _set_sb_leds]
gcode:
    {% set red = params.RED|default(0)|float %}
    {% set green = params.GREEN|default(0)|float %}
    {% set blue = params.BLUE|default(0)|float %}
    {% set white = params.WHITE|default(0)|float %}
    {% set led = params.LED|string %}
    {% set idx = (params.IDX|string).split(',') %}
    {% set transmit_last = params.TRANSMIT|default(1) %}
    
    {% for led_index in idx %}
        {% set transmit=transmit_last if loop.last else 0 %}
        set_led led={led} red={red} green={green} blue={blue} white={white} index={led_index} transmit={transmit}
    {% endfor %}

[gcode_macro _set_sb_leds_by_name]
gcode:
    {% set leds_name = params.LEDS %}
    {% set color_name = params.COLOR %}
    {% set color = printer["gcode_macro _sb_vars"].colors[leds_name][color_name] %}
    {% set led = printer["gcode_macro _sb_vars"][leds_name + "_led_name"] %}#####################################################################
Stealthburner LEDs

#####################################################################
    {% set idx = printer["gcode_macro _sb_vars"][leds_name + "_idx"] %}
    {% set transmit = params.TRANSMIT|default(1) %}

    _set_sb_leds led={led} red={color.r} green={color.g} blue={color.b} white={color.w} idx="{idx}" transmit={transmit}

[gcode_macro _set_logo_leds]
gcode:
    {% set red = params.RED|default(0)|float %}
    {% set green = params.GREEN|default(0)|float %}
    {% set blue = params.BLUE|default(0)|float %}
    {% set white = params.WHITE|default(0)|float %}
    {% set led = printer["gcode_macro _sb_vars"].logo_led_name %}
    {% set idx = printer["gcode_macro _sb_vars"].logo_idx %}
    {% set transmit=params.TRANSMIT|default(1) %}

    _set_sb_leds led={led} red={red} green={green} blue={blue} white={white} idx="{idx}" transmit={transmit}

[gcode_macro _set_nozzle_leds]
gcode:
    {% set red = params.RED|default(0)|float %}
    {% set green = params.GREEN|default(0)|float %}
    {% set blue = params.BLUE|default(0)|float %}
    {% set white = params.WHITE|default(0)|float %}
    {% set led = printer["gcode_macro _sb_vars"].nozzle_led_name %}
    {% set idx = printer["gcode_macro _sb_vars"].nozzle_idx %}
    {% set transmit=params.TRANSMIT|default(1) %}

    _set_sb_leds led={led} red={red} green={green} blue={blue} white={white} idx="{idx}" transmit={transmit}

[gcode_macro _set_logo_leds_off]
gcode:
    {% set transmit=params.TRANSMIT|default(1) %}
    _set_logo_leds red=0 blue=0 green=0 white=0 transmit={transmit}

[gcode_macro _set_nozzle_leds_on]
gcode:
    {% set transmit=params.TRANSMIT|default(1) %}
    _set_sb_leds_by_name leds="nozzle" color="on" transmit={transmit}

[gcode_macro _set_nozzle_leds_off]
gcode:
    {% set transmit=params.TRANSMIT|default(1) %}
    _set_sb_leds_by_name leds="nozzle" color="off" transmit={transmit}

[gcode_macro _status_off]
gcode:
    _set_logo_leds_off transmit=0
    _set_nozzle_leds_off

[gcode_macro _status_ready]
gcode:
    _set_sb_leds_by_name leds="logo" color="standby" transmit=0
    _set_sb_leds_by_name leds="nozzle" color="standby" transmit=1

[gcode_macro _status_busy]
gcode:
    _set_sb_leds_by_name leds="logo" color="busy" transmit=0
    _set_nozzle_leds_on

[gcode_macro _status_heating]
gcode:
    _set_sb_leds_by_name leds="logo" color="heating" transmit=0
    _set_sb_leds_by_name leds="nozzle" color="heating" transmit=1

[gcode_macro _status_leveling]
gcode:
    _set_sb_leds_by_name leds="logo" color="leveling" transmit=0
    _set_nozzle_leds_on

[gcode_macro _status_homing]
gcode:
    _set_sb_leds_by_name leds="logo" color="homing" transmit=0
    _set_nozzle_leds_on

[gcode_macro _status_cleaning]
gcode:
    _set_sb_leds_by_name leds="logo" color="cleaning" transmit=0
    _set_nozzle_leds_on

[gcode_macro _status_meshing]
gcode:
    _set_sb_leds_by_name leds="logo" color="meshing" transmit=0
    _set_nozzle_leds_on

[gcode_macro _status_calibrating_z]
gcode:
    _set_sb_leds_by_name leds="logo" color="calibrating_z" transmit=0
    _set_nozzle_leds_on

[gcode_macro _status_printing]
gcode:
    _set_sb_leds_by_name leds="logo" color="printing" transmit=0
    _set_nozzle_leds_on


